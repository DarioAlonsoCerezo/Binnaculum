<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Binnaculum.UI.DeviceTests.Runners.VisualRunner.Pages.TestDiscoveryPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Binnaculum.UI.DeviceTests.Runners.VisualRunner.ViewModels"
             Title="Test Discovery"
             Style="{StaticResource BasePageStyle}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Search and Filter Bar -->
        <StackLayout Grid.Row="0" 
                     Orientation="Horizontal" 
                     Padding="16,8"
                     BackgroundColor="{StaticResource SurfaceColor}">
            <Entry x:Name="SearchEntry"
                   Placeholder="Search tests..."
                   Text="{Binding SearchText}"
                   Style="{StaticResource SearchEntryStyle}"
                   HorizontalOptions="FillAndExpand" />
            <Button Text="ðŸ”„"
                    Command="{Binding RefreshTestsCommand}"
                    IsEnabled="{Binding IsDiscovering, Converter={StaticResource InvertedBooleanConverter}}"
                    Style="{StaticResource SecondaryButtonStyle}"
                    WidthRequest="50" />
        </StackLayout>

        <!-- Action Buttons -->
        <StackLayout Grid.Row="1" 
                     Orientation="Horizontal" 
                     Padding="16,8"
                     BackgroundColor="{StaticResource SurfaceColor}">
            <Button Text="Select All"
                    Command="{Binding SelectAllCommand}"
                    Style="{StaticResource SecondaryButtonStyle}"
                    HorizontalOptions="Start" />
            <Button Text="Unselect All"
                    Command="{Binding UnselectAllCommand}"
                    Style="{StaticResource SecondaryButtonStyle}"
                    HorizontalOptions="Start" />
            <Label Text="{Binding StatusMessage}"
                   TextColor="{StaticResource SecondaryTextColor}"
                   VerticalOptions="Center"
                   HorizontalOptions="FillAndExpand"
                   HorizontalTextAlignment="End" />
        </StackLayout>

        <!-- Test Tree View -->
        <ScrollView Grid.Row="2">
            <StackLayout>
                <!-- Discovery Loading Indicator -->
                <ActivityIndicator IsVisible="{Binding IsDiscovering}"
                                   IsRunning="{Binding IsDiscovering}"
                                   Color="{StaticResource AccentTextColor}"
                                   HeightRequest="50"
                                   VerticalOptions="Center" />

                <!-- Test Assemblies List -->
                <CollectionView ItemsSource="{Binding FilteredTestAssemblies}"
                                IsVisible="{Binding IsDiscovering, Converter={StaticResource InvertedBooleanConverter}}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:TestAssemblyViewModel">
                            <Grid>
                                <Frame Style="{StaticResource TestItemCardStyle}">
                                    <StackLayout>
                                        <!-- Assembly Header -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <CheckBox Grid.Column="0"
                                                      IsChecked="{Binding IsSelected}"
                                                      VerticalOptions="Center" />

                                            <Label Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   Style="{StaticResource TestTitleStyle}"
                                                   VerticalOptions="Center" />

                                            <Label Grid.Column="2"
                                                   Text="{Binding TotalTests, StringFormat='{0} tests'}"
                                                   Style="{StaticResource TestDescriptionStyle}"
                                                   VerticalOptions="Center"
                                                   Margin="8,0" />

                                            <Button Grid.Column="3"
                                                    Text="{Binding IsExpanded, Converter={StaticResource ExpandCollapseTextConverter}}"
                                                    Command="{Binding ToggleExpandCommand}"
                                                    BackgroundColor="Transparent"
                                                    TextColor="{StaticResource AccentTextColor}"
                                                    FontSize="18"
                                                    WidthRequest="40"
                                                    HeightRequest="40" />
                                        </Grid>

                                        <!-- Assembly Details -->
                                        <StackLayout IsVisible="{Binding IsExpanded}"
                                                     Margin="20,8,0,0">
                                            
                                            <!-- Test Classes -->
                                            <CollectionView ItemsSource="{Binding TestClasses}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="viewmodels:TestClassViewModel">
                                                        <StackLayout>
                                                            <!-- Test Class Header -->
                                                            <Grid Margin="0,4">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>

                                                                <CheckBox Grid.Column="0"
                                                                          IsChecked="{Binding IsSelected}"
                                                                          VerticalOptions="Center" />

                                                                <Label Grid.Column="1"
                                                                       Text="{Binding Name}"
                                                                       FontSize="14"
                                                                       FontAttributes="Bold"
                                                                       TextColor="{StaticResource PrimaryTextColor}"
                                                                       VerticalOptions="Center" />

                                                                <Label Grid.Column="2"
                                                                       Text="{Binding TotalTests, StringFormat='{0} tests'}"
                                                                       Style="{StaticResource TestDescriptionStyle}"
                                                                       VerticalOptions="Center"
                                                                       Margin="8,0" />

                                                                <Button Grid.Column="3"
                                                                        Text="{Binding IsExpanded, Converter={StaticResource ExpandCollapseTextConverter}}"
                                                                        Command="{Binding ToggleExpandCommand}"
                                                                        BackgroundColor="Transparent"
                                                                        TextColor="{StaticResource AccentTextColor}"
                                                                        FontSize="14"
                                                                        WidthRequest="30"
                                                                        HeightRequest="30" />
                                                            </Grid>

                                                            <!-- Test Cases -->
                                                            <CollectionView ItemsSource="{Binding TestCases}"
                                                                            IsVisible="{Binding IsExpanded}"
                                                                            Margin="20,0,0,0">
                                                                <CollectionView.ItemTemplate>
                                                                    <DataTemplate x:DataType="viewmodels:TestCaseViewModel">
                                                                        <Grid Margin="0,2">
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="Auto" />
                                                                                <ColumnDefinition Width="Auto" />
                                                                                <ColumnDefinition Width="*" />
                                                                                <ColumnDefinition Width="Auto" />
                                                                            </Grid.ColumnDefinitions>

                                                                            <CheckBox Grid.Column="0"
                                                                                      IsChecked="{Binding IsSelected}"
                                                                                      VerticalOptions="Center" />

                                                                            <Border Grid.Column="1"
                                                                                    Style="{StaticResource TestStatusBadgeStyle}"
                                                                                    BackgroundColor="{Binding Status, Converter={StaticResource TestStatusToColorConverter}}"
                                                                                    Margin="8,0" />

                                                                            <Label Grid.Column="2"
                                                                                   Text="{Binding DisplayName}"
                                                                                   FontSize="13"
                                                                                   TextColor="{StaticResource PrimaryTextColor}"
                                                                                   VerticalOptions="Center" />

                                                                            <Label Grid.Column="3"
                                                                                   Text="{Binding Duration, StringFormat='{0:mm\\:ss\\.ff}'}"
                                                                                   Style="{StaticResource TestDescriptionStyle}"
                                                                                   VerticalOptions="Center"
                                                                                   IsVisible="{Binding IsCompleted}" />
                                                                        </Grid>
                                                                    </DataTemplate>
                                                                </CollectionView.ItemTemplate>
                                                            </CollectionView>
                                                        </StackLayout>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </StackLayout>
                                    </StackLayout>
                                </Frame>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Empty State -->
                <StackLayout IsVisible="{Binding TestAssemblies.Count, Converter={StaticResource IntToBooleanConverter}, ConverterParameter=0}"
                             VerticalOptions="CenterAndExpand"
                             HorizontalOptions="Center"
                             Padding="32">
                    <Label Text="No tests found"
                           FontSize="18"
                           TextColor="{StaticResource SecondaryTextColor}"
                           HorizontalOptions="Center" />
                    <Label Text="Tap the refresh button to discover tests"
                           FontSize="14"
                           TextColor="{StaticResource SecondaryTextColor}"
                           HorizontalOptions="Center"
                           Margin="0,8,0,0" />
                </StackLayout>
            </StackLayout>
        </ScrollView>

        <!-- Bottom Action Bar -->
        <Grid Grid.Row="3" 
              BackgroundColor="{StaticResource SurfaceColor}"
              Padding="16,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackLayout Grid.Column="0" 
                         Orientation="Horizontal"
                         VerticalOptions="Center">
                <Label Text="Selected: "
                       Style="{StaticResource TestDescriptionStyle}"
                       VerticalOptions="Center" />
                <Label Text="{Binding ., Converter={StaticResource SelectedTestCountConverter}}"
                       TextColor="{StaticResource AccentTextColor}"
                       FontAttributes="Bold"
                       VerticalOptions="Center" />
            </StackLayout>

            <Button Grid.Column="1"
                    Text="Run Selected Tests"
                    Command="{Binding RunSelectedTestsCommand}"
                    Style="{StaticResource PrimaryButtonStyle}"
                    HorizontalOptions="End" />
        </Grid>
    </Grid>
</ContentPage>