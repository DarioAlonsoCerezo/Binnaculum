---
name: Setup Branch Protection

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - show what would be configured without making changes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  setup-branch-protection:
    name: Configure Main Branch Protection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Branch Protection Rules
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            const dryRun = '${{ inputs.dry_run }}' === 'true';
            
            console.log(`ðŸ›¡ï¸ Setting up branch protection for ${owner}/${repo}:${branch}`);
            console.log(`Dry run mode: ${dryRun}`);
            
            // Define the branch protection configuration
            const protectionConfig = {
              owner,
              repo,
              branch,
              required_status_checks: {
                strict: true, // Require branches to be up to date before merging
                checks: [
                  { context: 'essential-checks' },
                  { context: 'android-build' },
                  { context: 'pr-check-summary' }
                ]
              },
              enforce_admins: true, // Include administrators in restrictions
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                require_last_push_approval: false
              },
              restrictions: null, // No user/team restrictions, but other settings apply
              allow_force_pushes: false,
              allow_deletions: false,
              block_creations: false,
              required_conversation_resolution: false
            };
            
            if (dryRun) {
              console.log('ðŸ” DRY RUN - Branch protection configuration:');
              console.log(JSON.stringify(protectionConfig, null, 2));
              console.log('\nâœ… This would be applied to the main branch');
              console.log('Re-run without dry_run=true to apply these settings');
              return;
            }
            
            try {
              // Apply the branch protection rules
              console.log('ðŸ”§ Applying branch protection rules...');
              
              const response = await github.rest.repos.updateBranchProtection(protectionConfig);
              
              console.log('âœ… Branch protection rules successfully applied!');
              console.log('\nðŸ“‹ Applied Configuration:');
              console.log(`â€¢ Required status checks: ${protectionConfig.required_status_checks.checks.map(c => c.context).join(', ')}`);
              console.log(`â€¢ Required PR reviews: ${protectionConfig.required_pull_request_reviews.required_approving_review_count}`);
              console.log(`â€¢ Code owner reviews: ${protectionConfig.required_pull_request_reviews.require_code_owner_reviews}`);
              console.log(`â€¢ Dismiss stale reviews: ${protectionConfig.required_pull_request_reviews.dismiss_stale_reviews}`);
              console.log(`â€¢ Enforce for admins: ${protectionConfig.enforce_admins}`);
              console.log(`â€¢ Up-to-date branches required: ${protectionConfig.required_status_checks.strict}`);
              
              console.log('\nðŸ›¡ï¸ Your main branch is now protected!');
              
              // Create a summary
              core.summary
                .addHeading('ðŸ›¡ï¸ Branch Protection Setup Complete')
                .addTable([
                  [{data: 'Setting', header: true}, {data: 'Value', header: true}],
                  ['Branch', 'main'],
                  ['Required Reviews', '1 approval'],
                  ['Code Owner Reviews', 'Required'],
                  ['Status Checks', 'essential-checks, android-build, pr-check-summary'],
                  ['Up-to-date Required', 'Yes'],
                  ['Admin Enforcement', 'Yes'],
                  ['Direct Pushes', 'Blocked']
                ])
                .addRaw('\n### âœ… Benefits\n')
                .addList([
                  'All changes must go through pull requests',
                  'Your approval required via CODEOWNERS file',
                  'CI/CD validation enforced before merge',
                  'Branches must be current with main',
                  'Protection applies even to repository admins'
                ])
                .write();
                
            } catch (error) {
              console.error('âŒ Failed to apply branch protection rules:', error);
              
              if (error.status === 403) {
                console.error('ðŸ”’ Permission denied. Make sure the GITHUB_TOKEN has admin permissions.');
                console.error('You may need to run this workflow with elevated permissions or apply rules manually.');
              }
              
              core.setFailed(`Branch protection setup failed: ${error.message}`);
              throw error;
            }

      - name: Verify Protection Status
        if: inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            
            try {
              console.log('ðŸ” Verifying branch protection status...');
              
              const response = await github.rest.repos.getBranchProtection({
                owner,
                repo,
                branch
              });
              
              const protection = response.data;
              console.log('âœ… Branch protection verification successful!');
              console.log('\nðŸ“Š Current Protection Status:');
              console.log(`â€¢ Required status checks: ${protection.required_status_checks?.checks?.map(c => c.context).join(', ') || 'None'}`);
              console.log(`â€¢ Strict mode: ${protection.required_status_checks?.strict || false}`);
              console.log(`â€¢ Required reviews: ${protection.required_pull_request_reviews?.required_approving_review_count || 0}`);
              console.log(`â€¢ Code owner reviews: ${protection.required_pull_request_reviews?.require_code_owner_reviews || false}`);
              console.log(`â€¢ Admin enforcement: ${protection.enforce_admins?.enabled || false}`);
              
            } catch (error) {
              console.warn('âš ï¸  Could not verify protection status:', error.message);
              // Don't fail the workflow for verification issues
            }

      - name: Next Steps
        if: inputs.dry_run != 'true'
        run: |
          echo "## ðŸŽ‰ Branch Protection Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your main branch is now protected with:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required pull request reviews (1 approval)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code owner review enforcement (via .github/CODEOWNERS)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required CI status checks (essential-checks, android-build, pr-check-summary)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Up-to-date branch requirements" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Admin enforcement (applies to all users including you)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What this means:" >> $GITHUB_STEP_SUMMARY
          echo "- All changes to main must go through pull requests" >> $GITHUB_STEP_SUMMARY
          echo "- Your approval is required for all PRs (you're the code owner)" >> $GITHUB_STEP_SUMMARY
          echo "- CI/CD tests must pass before merging" >> $GITHUB_STEP_SUMMARY
          echo "- PRs must be up-to-date with main branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Branch Protection Settings](https://github.com/${{ github.repository }}/settings/branches)" >> $GITHUB_STEP_SUMMARY